---
date: 08/12/2025
editor: visual
---

# An EEG Processing Pipeline {.unnumbered}

In this assignment we intended to emulate a full EEG data processing pipeline using the concepts introduced across the different workgroups.

We load the required packages

```{r}
#| message: false
#| warning: false
#| include: false
# load required libraries 
library(tidyverse)
library(car)
library(emmeans)
library(modelbased)
library(ggeffects)
```

## Task #1: Read dataframe

For the assignment we use a large file containing real EEG data from 17 subjects collected across 4 experimental conditions.

The data is contained in the file `/data/eegSampleData.Rda` .

Load the data into the environment using `readRDS()`

```{r}
# read data
eegData<-readRDS('./data/eegSampleData.Rda')
```

The data file contains the following columns:

-   **time:** numerical time vector in seconds of the collected data with respect to the visual trigger, ranging from -0.2 (200ms before the trigger) to 0.8 (800 ms after the trigger)

-   **Subject**: Factor with 17 levels from "1" to "17" indicating the participant

-   **Condition:** categorical factor with 4 levels: "CondA", "CondB", "CondC" and "CondD"

-   **Fp1 to CB2:** 62 columns with voltage values measured at each electrode on the EEG collection.

::: callout-important
In the dataset uploaded in the Posit Cloud, Condition was coded as "11", "22","23","24" instead of "CondA", "CondB", "CondC", "CondD".

If you want to replicate this assignment key, run the following line to recode the levels before continuing.

``` r
levels(eegData$Condition)<-c("CondA","CondB","CondC","CondD")
```
:::

## **Task#2: Summarize and reorganize the data**

We want to Evaluate the presence or absence of a N400 Event Related Potential (ERP) on the dataset. The N400 component appears in the range of 250 to 550ms after the stimulus onset, and it is considered a broad central-anterior component.

In order to do that we have to perform the following:

-   Calculate the average voltage in the time window 250-550ms for all Electrodes.

-   Select the relevant Regions of Interest:

    -   **Anterior:** electrodes F1, F2, F3, F4, F5, F6, Fz

    -   **Central:** electrodes C1, C2, C3, C4, C5, C6, Cz

-   Compare the average voltage across experimental conditions against the **Control Condition**, which in this case is **Condition D**

### Task #2.1: Subset data

Select subset of the data for the analysis:

-   Time in the range 0.250 to 0.550 s

-   Electrodes for the Anterior and Central regions defined above.

```{r}
eegDataFiltered <- eegData %>% 
  select(time,Subject,Condition,F1,F1,F3,F4,F5,F6,Fz,C1,C2,C3,C4,C5,C6,Cz) %>%
  filter(time >=0.250 & time <=0.550)

# Remove from the memory the full data set now that we have filtered the data
rm(eegData)
```

### Task #2.2: Rearrange the data from wide to long format

We convert the data from wide to long format using the steps practiced in Workgroup 2: <https://lpablosrobles.github.io/Fundamentals-Linear-Models-workbook/data_organization.html>

```{r}
eegDataFiltered_long<-pivot_longer(eegDataFiltered, 
                                   cols = F1:Cz, 
                                   names_to = "Electrode", 
                                   values_to = "Voltage")
head(eegDataFiltered_long)
```

### Task #2.3: Calculate data averages in the N400 window

Calculate average of data in the N400 window by averaging all points from 250 to 550 ms (already selected before).

We calculate the average in the window for each condition per subject

```{r}
eegDataAveraged <- eegDataFiltered_long %>%
  group_by(Subject,Condition,Electrode) %>%
  summarize(AvgVoltage = mean(Voltage))

head(eegDataAveraged)
```

## Task#3: Create a linear model of the Average Voltage

### Task#3.1: Fz Electrode

-   Select the data in the **Fz electrode**

-   Create a model to investigate if the AverageVoltage on the Fz electrode in the N400 window is related to the **Condition** factor.

```{r}
eegData_Fz = eegDataAveraged %>% filter(Electrode=="Fz")
mFz <- lm(AvgVoltage~Condition, data=eegData_Fz)
summary(mFz)
```

From the results, we can infer that:

-   There appears to be a significant difference across conditions on the Average voltage in a window.

-   Condition B and C average voltages differ from the reference Condition A, however Condition D does not.

-   The model significance indicates that the inclusion of the Condition predictor in the model improved the explanatory power compared with an intercept only (null) model.

The exercise Task 3.3, however, asked to consider **Condition D as a reference condition**, while the model by default provides the results considering Condition A as the reference. To correct this, we relevel the Condition factor:

```{r}
eegData_Fz <- eegData_Fz %>% mutate(Condition=relevel(Condition,"CondD"))
mFz <- lm(AvgVoltage~Condition, data=eegData_Fz)
summary(mFz)
```

Now, as you can see, the coefficients changes, and there is only a very marginally significant coefficient (`ConditionCondC` ), indicating that no Condition is significantly different from the control D.

#### Marginal means calculation

Let's look at the marginal means using the `modelbased` library and plot them.

```{r}
#| warning: false
emmFz <- estimate_means(mFz, by="Condition")
emmFz

plot(emmFz) + theme_minimal()
```

As we can see from the marginal means and plot, it looks like Condition A and D are slightly different than condition A.

#### Post-hoc analysis

We understand the differences between all values, we run a post-hoc analysis with all pairwise comparisons. Let's use for example Tukey correction (less strict than Bonferroni)

```{r}
estimate_contrasts(mFz, contrast="Condition", p_adjust = "tukey", backend="emmeans")

```

We see a few interesting things in the output above:

-   Only the contrast between condition C and Condition A seems to be significant, when applying the relevant correction for multiple comparisons. As a comparison, look at what would have been the result if the correction was not applied:

```{r}
estimate_contrasts(mFz, contrast="Condition", backend="emmeans")
```

-   In this case also the comparison between Conditions A and B is signficant, but it is likely a Type I error due to the use of multiple comparisons.

::: callout-important
#### Analysis using `emmeans`

Considering that the `modelbased` package is relatively new and the wide usage of `emmeans` , I include here the same calculation using `emmeans` for reference, as the nomenclature and output is a bit different. Remember though that `modelbased` is a wrapper that calls emmeans on the background.

```{r}
emmFz_alt <- emmeans(mFz,~Condition)
emmFz_alt
```

Using plot directly on the `emmeans` output produces the same plot in a different format but with the same information.

```{r}
plot(emmFz_alt, horizontal = FALSE)
```

Finally, to perform pairwise comparisons, the same function `emmeans` can be used, but using the pairwise word in the formula as below:

```{r}
emmeans(mFz,pairwise~Condition)
```

As you can see from the output, the function automatically applied a Tukey correction, without the need to specify it. Results are the same we obtained before
:::

#### Model assumption checking

Finally, let's check the model assumptions for validity. First on the linearity of the residuals

```{r}
#| warning: false
qqnorm(mFz$residuals)
qqline(mFz$residuals)
hist(mFz$residuals, breaks = 25)

shapiro.test(mFz$residuals)
```

-   The qqplot and histogram, show that the values are quite normal, however outliers are affecting the results. In the real data set, with additional subjects this will not appear, and the model will show to be valid. For the purpose of this exercise, we will report the observations.

For the homogeneity of variance we use the test that confirms the model meets the assumptions

```{r}
ncvTest(mFz)
```

### Task#3.2: Cz Electrode

We repeat the above process for the Cz electrode:

#### Model fit

-   Select the data in the **Cz electrode**

-   Create a model to investigate if the AverageVoltage on the Fz electrode in the N400 window is related to the **Condition** factor.

```{r}
eegData_Cz = eegDataAveraged %>% filter(Electrode=="Cz") %>% mutate(Condition=relevel(Condition,"CondD"))
mCz <- lm(AvgVoltage~Condition, data=eegData_Cz)
summary(mCz)

confint(mCz)
```

#### Marginal means calculation and post-hoc analysis

```{r}
emmCz <- estimate_means(mCz, by="Condition")
emmCz

plot(emmCz) + theme_minimal()


```

```{r}
estimate_contrasts(mCz, contrast="Condition", p_adjust = "tukey", backend="emmeans")
```

In this case, there are three significant comparisons: between Conditions A and B, A and C and also C and D.

#### Model assumptions checking

```{r}
#| warning: false
qqnorm(mCz$residuals)
qqline(mCz$residuals)
hist(mCz$residuals, breaks = 25)

shapiro.test(mCz$residuals)
```

```{r}
ncvTest(mCz)
```

The results are similar to the Fz calculations, were the model failed on the assumption related to the normality of residuals due to a few outliers that would likely disappear when using the data of more subjects.

### Task #3.3: Report the models for both Fz and Cz:

Report the results of the analysis performed in the APA format described in the lecture including if necessary any post-hoc analysis performed if needed to compare against the [**reference Condition D.**]{.underline}

::: callout-warning
We saw on the output from the different comparisons that a number of them show significant differences. Which ones to report however [**depend on your experimental design.**]{.underline} The assignment asked to report against a reference condition D, which would imply that the other comparisons not against D are not relevant or interpretable for the experimental manipulation.

This can often be the case in linguistics experiments, where the different conditions are to be compared to a control. Based on this assumption we write the reporting below
:::

> In an Event Related Potential (ERP) study, the effect of experimental manipulation \<\<\<HERE THE EXPERIMENT DESCRIPTION\>\>\> was assessed using a linear model analysis to investivate the presence of a N400 component. The analysis was performed on two sites (Electrodes Fz and Cz) on the averaged voltage in the time window \[250ms, 450ms\]. Three conditions (A, B, C) were compared to a a control condition D.
>
> Linear model results showed a significant effect for Condition both in Electrode Fz ($F(3,64)=3.33,p=.0.25,R^2_{adj}=0.09$) and Cz ($F(3,64)=6.24,p<.001,R^2{adj}=0.19$).
>
> In the Frontal region, as measured in the site Fz, the fitted model was:
>
> $$AverageVoltage_{Fz} = -1.36 -0.80\times CondA+0.83\times CondB+1.47\times CondC$$
>
> The model did not reveal any significant effect of Condition with respect to the reference Condition D.
>
> | Coefficient | beta | Confidence Interval | t | p |
> |------------------|--------------|--------------|--------------|--------------|
> | Intercept (corresponding to Condition D) | -1.36 | \[-2.45, -0.28\] | t(64) = -2.51 | p = 0.014 |
> | Condition A | -0.80 | \[-2.34, 0.73\] | t(64) = -1.05 | p = 0.299 |
> | Condition B | 0.83 | \[-0.70, 2.37\] | t(64) = 1.09 | p = 0.281 |
> | Condition C | 1.47 | \[-0.06, 3.01\] | t(64) = 1.92 | p = 0.060 |
>
> In the Central Region, measured at the site Cz, the fitted model was:
>
> $$AverageVoltage_{Cz} = -2.02 -0.26\times CondA+1.83\times CondB+2.28\times CondC$$

> | Coefficient | beta | Confidence Interval | t | p |   |   |   |
> |--------------|--------------|--------------|--------------|--------------|--------------|--------------|--------------|
> | Intercept (corresponding to Condition D) | -2.02 | \[-3.04, -0.99\] | t(64) = -3.94 | p\<.001 |  |  |  |
> | Condition A | -0.26 | \[-1.70, 1.19\] | t(64) = -0.36 | p = 0.723 | p = 0.723 |  |  |
> | Condition B | 1.83 | \[0.39, 3.28\] | t(64) = 2.53 | p = 0.014 |  |  |  |
> | Condition C | 2.28 | \[0.83, 3.73\] | t(64) = 3.15 | p = 0.002 |  |  |  |
>
> Post-hoc testing based on estimation of the marginal means of the model showed a significant positive Average Voltage in Conditions C with respect to Control Condition D ($Diff_{C-D}=2.28, 95\%CI[0.37,4.19],SE=0.72,t(64)3.15,p=0.013$). The other two conditions showed a marginal significant positive difference in Condition B ($Diff_{B-D}= 1.83, 95\%CI[-0.08,3.74],SE=0.72,t(64)=-2.53,p=0.065$) and not a significant difference in Condition A ($Diff_{A-D}= -0.26, 95\%CI[-2.17,1.65],SE=0.72,t(64)=0.36,p=0.984$).
>
> Pairwise post-hoc comparisons were performed using Tukey correction to account for multiple comparisons.
>
> Model assumptions checking revealed deviations from the normality assumptions on both models that would require a more detailed look at the data outliers or likely an increase of the number of subjects in the study.

### EXTRA CREDIT: Task #4 Create factor encoding Region of interest.

### Task 4.1: Create new factor

Create a new variable with a factor to encode the **Region of Interest called ROI** based on the criteria defined above and two levels:

-   **Anterior:** electrodes F1, F2, F3, F4, F5, F6, Fz

-   **Central:** electrodes C1, C2, C3, C4, C5, C6, Cz

Tip: You can create a variable as a function of the value of another variable using `case_when()` . Read the following page for instructions : <https://www.statology.org/conditional-mutating-r/>

```{r}
eegDataAveraged<- eegDataAveraged %>% mutate(Condition=relevel(Condition,"CondD"))

eegDataAveraged$roi <- case_when(
  eegDataAveraged$Electrode %in% c("F1","F2","F3","F4","F5","F6","Fz") ~ "Anterior",
  eegDataAveraged$Electrode %in% c("C1","C2","C3","C4","C5","C6","Cz") ~ "Central"
)
eegDataAveraged$roi<-as.factor(eegDataAveraged$roi)
```

### Task 4.2: Multiple linear regression

-   Create a model to investigate if the AverageVoltage in the N400 window is related to the **Condition** and **ROI** predictors.

```{r}
mCA <-lm(AvgVoltage~Condition+roi, data = eegDataAveraged)
summary(mCA)
```

If we calculate the marginal means and plot we can see that there are no major differences between the two ROIs.

```{r}
#| warning: false
emm<-estimate_means(mCA,by=c("Condition","roi"))
emm

plot(emm)
```

```{r}

estimate_contrasts(mCA, "Condition", by=c("roi"),p_adjust = "tukey",backend = "emmeans")
```

What you can see from the results and the graphs is that the marginal means show difference between conditions, but same behavior is observed across Regions of Interest, without particular differences between Anterior and Central regions.

However, you can see that a number of comparisons that were not significant before are now that we have included more data (more sites). We can compare model with and without a parameter.

Please note that a model with only the Region of Interest `roi` does not make theoretical sense in general, as it will imply that the activity is different independently of the manipulation.

```{r}
mCA_0<-lm(AvgVoltage~Condition, data=eegDataAveraged)
summary(mCA_0)

anova(mCA_0,mCA)
```

As expected, the region of interest does not improve the model.

We will see that introducing an interaction between the two factors can change this interpretation after the Task#5 in Assignment #6.

## 
